const moment = require('moment-timezone');
const { sendWithChannelButton } = require('../lib/utils');
const config = require('../../config');

const ramadanData = {
    duas: [
        "اللَّهُمَّ اجْعَلْ صِيَامِي فِيهِ صِيَامَ الصَّائِمِينَ، وَ قِيَامِي فِيهِ قِيَامَ الْقَائِمِينَ، وَ نَبِّهْنِي فِيهِ عَنْ نَوْمَةِ الْغَافِلِينَ، وَ هَبْ لِي جُرْمِي فِيهِ يَا إِلَهَ الْعَالَمِينَ، وَ اعْفُ عَنِّي يَا عَافِياً عَنِ الْمُجْرِمِينَ.",
        "اللَّهُمَّ قَرِّبْنِي فِيهِ إِلَى مَرْضَاتِكَ، وَ جَنِّبْنِي فِيهِ مِنْ سَخَطِكَ وَ نَقِمَاتِكَ، وَ وَفِّقْنِي فِيهِ لِقِرَاءَةِ آيَاتِكَ، بِرَحْمَتِكَ يَا أَرْحَمَ الرَّاحِمِينَ.",
        "اللَّهُمَّ ارْزُقْنِي فِيهِ الذِّهْنَ وَ التَّنْبِيهَ، وَ بَاعِدْنِي فِيهِ مِنَ السَّفَاهَةِ وَ التَّمْوِيهِ، وَ اجْعَلْ لِي نَصِيباً مِنْ كُلِّ خَيْرٍ تُنْزِلُ فِيهِ، بِجُودِكَ يَا أَجْوَدَ الْأَجْوَدِينَ.",
        "اللَّهُمَّ قَوِّنِي فِيهِ عَلَى إِقَامَةِ أَمْرِكَ، وَ أَذِقْنِي فِيهِ حَلَاوَةَ ذِكْرِكَ، وَ أَوْزِعْنِي فِيهِ لِأَدَاءِ شُكْرِكَ بِكَرَمِكَ، وَ احْفَظْنِي فِيهِ بِحِفْظِكَ وَ سِتْرِكَ يَا أَبْصَرَ النَّاظِرِينَ.",
        "اللَّهُمَّ اجْعَلْنِي فِيهِ مِنَ الْمُسْتَغْفِرِينَ، وَ اجْعَلْنِي فِيهِ مِنْ عِبَادِكَ الصَّالِحِينَ الْقَانِتِينَ، وَ اجْعَلْنِي فِيهِ مِنَ أَوْلِيَائِكَ الْمُقَرَّبِينَ، بِرَأْفَتِكَ يَا أَرْحَمَ الرَّاحِمِينَ.",
        "اللَّهُمَّ لَا تَخْذُلْنِي فِيهِ لِتَعَرُّضِ مَعْصِيَتِكَ، وَ لَا تَضْرِبْنِي بِسِيَاطِ نَقِمَتِكَ، وَ زَحْزِحْنِي فِيهِ مِنْ مُوجِباتِ سَخَطِكَ بِمَنِّكَ وَ أَيَادِيكَ يَا مُنْتَهَى رَغْبَةِ الرَّاغِبِينَ.",
        "اللَّهُمَّ أَعِنِّي فِيهِ عَلَى صِيَامِهِ وَ قِيَامِهِ، وَ جَنِّبْنِي فِيهِ مِنْ هَفَوَاتِهِ وَ آثَامِهِ، وَ ارْزُقْنِي فِيهِ ذِكْرَكَ بِدَوامِهِ، بِتَوْفِيقِكَ يَا هَادِيَ الْمُضِلِّينَ.",
        "اللَّهُمَّ ارْزُقْنِي فِيهِ رَحْمَةَ الْأَيْتَامِ، وَ إِطْعَامَ الطَّعَامِ، وَ إِفْشَاءَ السَّلَامِ، وَ صُحْبَةَ الْكِرَامِ، بِطَوْلِكَ يَا مَلْجَأَ الْآمِلِينَ.",
        "اللَّهُمَّ اجْعَلْ لِي فِيهِ نَصِيباً مِنْ رَحْمَتِكَ الْوَاسِعَةِ، وَ اهْدِنِي فِيهِ لِبَرَاهِينِكَ السَّاطِعَةِ، وَ خُذْ بِنَاصِيَتِي إِلَى مَرْضَاتِكَ الْجَامِعَةِ، بِمَحَبَّتِكَ يَا أَمَلَ الْمُشْتَاقِينَ.",
        "اللَّهُمَّ اجْعَلْنِي فِيهِ مِنَ الْمُتَوَكِّلِينَ عَلَيْكَ، وَ اجْعَلْنِي فِيهِ مِنَ الْفَائِزِينَ لَدَيْكَ، وَ اجْعَلْنِي فِيهِ مِنَ الْمُقَرَّبِينَ إِلَيْكَ، بِإِحْسَانِكَ يَا غَايَةَ الطَّالِبِينَ.",
        "اللَّهُمَّ حَبِّبْ إِلَيَّ فِيهِ الْإِحْسَانَ، وَ كَرِّهْ إِلَيَّ فِيهِ الْفُسُوقَ وَ الْعِصْيَانَ، وَ حَرِّمْ عَلَيَّ فِيهِ السَّخَطَ وَ النِّيرَانَ بِعَوْنِكَ يَا غِيَاثَ الْمُسْتَغِيثِينَ.",
        "اللَّهُمَّ زَيِّنِّي فِيهِ بِالسِّتْرِ وَ الْعَفَافِ، وَ اسْتُرْنِي فِيهِ بِلِبَاسِ الْقُنُوعِ وَ الْكَفَافِ، وَ احْمِلْنِي فِيهِ عَلَى الْعَدْلِ وَ الْإِنْصَافِ، وَ آمِنِّي فِيهِ مِنْ كُلِّ مَا أَخَافُ بِعِصْمَتِكَ يَا عِصْمَةَ الْخَائِفِينَ.",
        "اللَّهُمَّ طَهِّرْنِي فِيهِ مِنَ الدَّنَسِ وَ الْأَقْذَارِ، وَ صَبِّرْنِي فِيهِ عَلَى كَائِنَاتِ الْأَقْدَارِ، وَ وَفِّقْنِي فِيهِ لِتُّقَى وَ صُحْبَةِ الْأَبْرَارِ، بِعَوْنِكَ يَا قُرَّةَ عَيْنِ الْمَسَاكِينِ.",
        "اللَّهُمَّ لَا تُؤَاخِذْنِي فِيهِ بِالْعَثَرَاتِ، وَ أَقِلْنِي فِيهِ مِنَ الْخَطَايَا وَ الْهَفَواتِ، وَ لَا تَجْعَلْنِي فِيهِ غَرَضاً لِلْبَلَايَا وَ الْآفَاتِ بِعِزَّتِكَ يَا عِزَّ الْمُسْلِمِينَ.",
        "اللَّهُمَّ ارْزُقْنِي فِيهِ طَاعَةَ الْخَاشِعِينَ، وَ اشْرَحْ فِيهِ صَدْرِي بِإِنَابَةِ الْمُخْبِتِينَ، بِأَمَانِكَ يَا أَمَانَ الْخَائِفِينَ.",
        "اللَّهُمَّ وَفِّقْنِي فِيهِ لِمُوَافَقَةِ الْأَبْرَارِ، وَ جَنِّبْنِي فِيهِ مُرَافَقَةَ الْأَشْرَارِ، وَ آوِنِي فِيهِ بِرَحْمَتِكَ إِلَى دَارِ الْقَرَارِ، بِإِلَهِيَّتِكَ يَا إِلَهَ الْعَالَمِينَ.",
        "اللَّهُمَّ اهْدِنِي فِيهِ لِصَالِحِ الْأَعْمَالِ، وَ اقْضِ لِي فِيهِ الْحَوَائِجَ وَ الْآمَالَ، يَا مَنْ لَا يَحْتَاجُ إِلَى التَّفْسِيرِ وَ السُّؤَالِ، يَا عَالِماً بِمَا فِي صُدُورِ الْعَالَمِينَ، صَلِّ عَلَى مُحَمَّدٍ وَ آلِهِ الطَّاهِرِينَ.",
        "اللَّهُمَّ نَبِّهْنِي فِيهِ لِبَرَكَاتِ أَسْحَارِهِ، وَ نَوِّرْ فِيهِ قَلْبِي بِضِيَاءِ أَنْوَارِهِ، وَ خُذْ بِكُلِّ أَعْضَائِي إِلَى اتِّباعِ آثَارِهِ، بِنُورِكَ يَا مُنَوِّرَ قُلُوبِ الْعَارِفِينَ.",
        "اللَّهُمَّ وَفِّرْ فِيهِ حَظِّي مِنْ بَرَكَاتِهِ، وَ سَهِّلْ سَبِيلِي إِلَى خَيْرَاتِهِ، وَ لَا تَحْرِمْنِي قَبُولَ حَسَنَاتِهِ، يَا هَادِياً إِلَى الْحَقِّ الْمُبِينِ.",
        "اللَّهُمَّ افْتَحْ لِي فِيهِ أَبْوابَ الْجِنَانِ، وَ أَغْلِقْ عَنِّي فِيهِ أَبْوَابَ النِّيرَانِ، وَ وَفِّقْنِي فِيهِ لِتِلاوَةِ الْقُرْآنِ، يَا مُنْزِلَ السَّكِينَةِ فِي قُلُوبِ الْمُؤْمِنِينَ.",
        "اللَّهُمَّ اجْعَلْ لِي فِيهِ إِلَى مَرْضَاتِكَ دَلِيلاً، وَ لَا تَجْعَلْ لِلشَّيْطَانِ فِيهِ عَلَيَّ سَبِيلاً، وَ اجْعَلِ الْجَنَّةَ لِي مَنْزِلاً وَ مَقِيلاً، يَا قَاضِيَ حَوائِجِ الطَّالِبِينَ.",
        "اللَّهُمَّ افْتَحْ لِي فِيهِ أَبْوَابَ فَضْلِكَ، وَ أَنْزِلْ عَلَيَّ فِيهِ بَرَكَاتِكَ، وَ وَفِّقْنِي فِيهِ لِمُوجِبَاتِ مَرْضَاتِكَ، وَ أَسْكِنِّي فِيهِ بُحْبُوحَاتِ جَنَّاتِكَ، يَا مُجِيبَ دَعْوَةِ الْمُضْطَرِّينَ.",
        "اللَّهُمَّ اغْسِلْنِي فِيهِ مِنَ الذُّنُوبِ، وَ طَهِّرْنِي فِيهِ مِنَ الْعُيُوبِ، وَ امْتَحِنْ قَلْبِي فِيهِ بِتَقْوَى الْقُلُوبِ، يَا مُقِيلَ عَثَرَاتِ الْمُذْنِبِينَ.",
        "اللَّهُمَّ إِنِّي أَسْأَلُكَ فِيهِ مَا يُرْضِيكَ، وَ أَعُوذُ بِكَ مِمَّا يُؤْذِيكَ، وَ أَسْأَلُكَ التَّوْفِيقَ فِيهِ لِأَنْ أُطِيعَكَ وَ لَا أَعْصِيَكَ، يَا جَوَادَ السَّائِلِينَ.",
        "اللَّهُمَّ اجْعَلْنِي فِيهِ مُحِبّاً لِأَوْلِيَائِكَ، وَ مُعَادِياً لِأَعْدَائِكَ، مُسْتَنّاً بِسُنَّةِ خَاتَمِ أَنْبِيَائِكَ، يَا عَاصِمَ قُلُوبِ النَّبِيِّينَ.",
        "اللَّهُمَّ اجْعَلْ سَعْيِي فِيهِ مَشْكُوراً، وَ ذَنْبِي فِيهِ مَغْفُوراً، وَ عَمَلِي فِيهِ مَقْبُولاً، وَ عَيْبِي فِيهِ مَسْتُوراً، يَا أَسْمَعَ السَّامِعِينَ.",
        "اللَّهُمَّ ارْزُقْنِي فِيهِ فَضْلَ لَيْلَةِ الْقَدْرِ، وَ صَيِّرْ أُمُورِي فِيهِ مِنَ الْعُسْرِ إِلَى الْيُسْرِ، وَ اقْبَلْ مَعَاذِيرِي، وَ حُطَّ عَنِّي الذَّنْبَ وَ الْوِزْرَ، يَا رَؤُوفاً بِعِبَادِهِ الصَّالِحِينَ.",
        "اللَّهُمَّ وَفِّرْ حَظِّي فِيهِ مِنَ النَّوَافِلِ، وَ أَكْرِمْنِي فِيهِ بِإِحْضَارِ الْمَسَائِلِ، وَ قَرِّبْ فِيهِ وَسِيلَتِي إِلَيْكَ مِنْ بَيْنِ الْوَسَائِلِ، يَا مَنْ لَا يَشْغَلُهُ إِلْحَاحُ الْمُلِحِّينَ.",
        "اللَّهُمَّ غَشِّنِي فِيهِ بِالرَّحْمَةِ، وَ ارْزُقْنِي فِيهِ التَّوْفِيقَ وَ الْعِصْمَةَ، وَ طَهِّرْ قَلْبِي مِنْ غَيَاهِبِ التُّهْمَةِ، يَا رَحِيماً بِعِبَادِهِ الْمُؤْمِنِينَ.",
        "اللَّهُمَّ اجْعَلْ صِيَامِي فِيهِ بِالشُّكْرِ وَ الْقَبُولِ عَلَى مَا تَرْضَاهُ وَ يَرْضَاهُ الرَّسُولُ، مُحْكَمَةً فُرُوعُهُ بِالْأُصُولِ، بِحَقِّ سَيِّدِنَا مُحَمَّدٍ وَ آلِهِ الطَّاهِرِينَ، وَ الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ."
    ],

    tips: [
        "🌙 تذكر أن رمضان شهر التغيير، فابدأ بنفسك.",
        "📖 اجعل لك ورداً يومياً من القرآن الكريم ولا تهجره.",
        "💧 الإكثار من شرب الماء بين الإفطار والسحور لتجنب الجفاف.",
        "🥗 ابدأ إفطارك بالتمر والماء كما فعل النبي ﷺ.",
        "📿 استغل وقت الفجر وما بعده للدعاء والذكر.",
        "🤝 بادر بالصلح مع من خاصمت، فرمضان شهر التسامح.",
        "🕋 لا تنسَ نية الصيام كل ليلة.",
        "🕯️ حاول التقليل من استخدام الهاتف والتركيز على العبادة.",
        "🕌 صلاة التراويح نور لليلك، فلا تحرم نفسك منها.",
        "✨ الصدقة في رمضان مضاعفة، تصدق ولو بالقليل."
    ]
};

async function ramadanCommand(sock, chatId, msg, args, commands) {
    const now = moment().tz('Africa/Casablanca');
    const ramadanStart = moment.tz("2026-02-18", "Africa/Casablanca");
    const ramadanEnd = moment.tz("2026-03-20", "Africa/Casablanca"); // Approx 30 days

    let header = `🌙 *ركن رمضان المبارك* 🌙\n\n`;

    // Check if we are in Ramadan
    if (now.isBetween(ramadanStart, ramadanEnd)) {
        const dayOfRamadan = now.diff(ramadanStart, 'days') + 1;
        const progress = Math.min(100, Math.max(0, (dayOfRamadan / 30) * 100));

        header += `✨ نحن اليوم في اليوم *${dayOfRamadan}* من رمضان 1447هـ\n`;
        header += `📊 نسبة الانقضاء: [${'█'.repeat(Math.floor(progress / 10))}${'░'.repeat(10 - Math.floor(progress / 10))}] ${progress.toFixed(1)}%\n\n`;

        const dua = ramadanData.duas[(dayOfRamadan - 1) % ramadanData.duas.length];
        const tip = ramadanData.tips[(dayOfRamadan - 1) % ramadanData.tips.length];

        header += `🤲 *دعاء اليوم:* ${dua}\n\n`;
        header += `💡 *نصيحة اليوم:* ${tip}\n\n`;
        header += `⏱️ لمعرفة مواقيت الإمساك والإفطار، استخدم: *.salat*`;
    } else if (now.isBefore(ramadanStart)) {
        const daysToRamadan = ramadanStart.diff(now, 'days');
        const hoursToRamadan = ramadanStart.diff(now, 'hours') % 24;

        header += `⏳ المتبقي على شهر رمضان المبارك:\n`;
        header += `🗓️ *${daysToRamadan}* يوم و *${hoursToRamadan}* ساعة\n\n`;
        header += `اللهم بلغنا رمضان لا فاقدين ولا مفقودين 🤲`;
    } else {
        header += `تقبل الله منا ومنكم صالح الأعمال. رمضان انتهى، نلبسكم الله من زينة العيد ✨`;
    }

    header += `\n\n⚔️ ${config.botName}`;

    await sendWithChannelButton(sock, chatId, header, msg);
}

module.exports = ramadanCommand;
