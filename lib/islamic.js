const fs = require('fs-extra');
const path = require('path');

const DUAS_PATH = path.join(__dirname, "..", "data", "duas-subscribers.json");

function loadDuasData() {
    try {
        if (!fs.existsSync(DUAS_PATH)) {
            if (!fs.existsSync(path.dirname(DUAS_PATH)))
                fs.mkdirSync(path.dirname(DUAS_PATH), { recursive: true });
            fs.writeFileSync(
                DUAS_PATH,
                JSON.stringify({ subscribers: [], enabled: true }, null, 2),
            );
            return { subscribers: [], enabled: true };
        }
        const data = JSON.parse(fs.readFileSync(DUAS_PATH, "utf8") || "{}");
        return {
            subscribers: Array.isArray(data.subscribers) ? data.subscribers : [],
            enabled: data.enabled !== undefined ? data.enabled : true,
        };
    } catch {
        return { subscribers: [], enabled: true };
    }
}

function saveDuasData(data) {
    try {
        fs.writeFileSync(DUAS_PATH, JSON.stringify(data, null, 2));
    } catch { }
}

const islamicDuas = [
    {
        title: "دعاء الصباح",
        dua: "اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ. اللَّهُمَّ إِنِّي أَسْأَلُكَ خَيْرَ هَذَا الْيَوْمِ فَتْحَهُ، وَنَصْرَهُ، وَنُورَهُ، وَبَرَكَتَهُ، وَهُدَاهُ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِيهِ وَشَرِّ مَا بَعْدَهُ.",
        category: "صباح",
    },
    {
        title: "دعاء المساء",
        dua: "اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ الْمَصِيرُ. أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوه عَلَى كُلِّ شَيْءٍ قَدِيرٌ.",
        category: "مساء",
    },
    {
        title: "دعاء الرزق",
        dua: "اللَّهُمَّ اكْفِنِي بِحَلَالِكَ عَنْ حَرَامِكَ، وَأَغْنِنِي بِفَضْلِكَ عَمَّنْ سِوَاكَ. اللَّهُمَّ إِنِّي أَسْأَلُكَ رِزْقًا وَاسِعًا طَيِّبًا مِنْ رِزْقِكَ، وَيَسِّرْ لِي طَلَبَهُ، وَاجْععلْهُ لِي مَصْدَرَ خَيْرٍ وَبَرَكَةٍ.",
        category: "رزق",
    },
    {
        title: "سيد الاستغفار",
        dua: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.",
        category: "استغفار",
    },
    {
        title: "دعاء الشفاء",
        dua: "اللَّهُمَّ رَبَّ النَّاسِ أَذْهِبِ الْبَاسَ، اشْفِهِ وَأَنْتَ الشَّافِي، لَا شِفَاءَ إِلَّا شِفاؤُكَ، شِفَاءً لَا يُغَادِرُ سَقَمًا.",
        category: "شفاء",
    },
    {
        title: "دعاء جامع",
        dua: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ.",
        category: "جامع",
    },
    {
        title: "دعاء الهداية",
        dua: "اللهم إني أسألك الهدى والتقى والعفاف والغنى، اللهم آتِ نفسي تقواها وزكها أنت خير من زكاها أنت وليها ومولاها.",
        category: "هداية",
    },
    {
        title: "دعاء تيسير الأمور",
        dua: "اللهم لا سهل إلا ما جعلته سهلاً، وأنت تجعل الحزن إذا شئت سهلاً، اللهم يسّر لي أمري واشرح لي صدري.",
        category: "تيسير",
    },
    {
        title: "دعاء يوم الجمعة",
        dua: "اللَّهُمَّ فِي يَوْمِ الْجُمُعَةِ، اجْعَلْنَا مِمَّنْ عَفَوْتَ عَنْهُمْ، وَرَضِيتَ عَنْهُمْ، وَغَفَرْتَ لَهُمْ، وَحَرَّمْتَهُمْ عَلَى النَّارِ، وَكَتَبْتَ لَهُمُ الْجَنَّةَ.",
        category: "جمعة",
    },
    {
        title: "ساعة الاستجابة يوم الجمعة",
        dua: "اللَّهُمَّ مَا قَسَمْتَ فِي هَذَا الْيَوْمِ مِنْ خَيْرٍ وَصِحَّةٍ وَسَعَةِ رِزْقٍ فَاجْعَلْ لَنَا مِنْهُ نَصِيبًا، وَما أَنْزَلْتَ فِيهِ مِنْ شَرٍّ وَبَلَاءٍ وَفِتْنَةٍ فَاصْرِفْهُ عَنَّا وَعَنْ جَمِيعِ الْمُسْلِمِينَ.",
        category: "جمعة",
    },
    {
        title: "نور الجمعة",
        dua: "اللَّهُمَّ نَوِّرْ قُلُوبَنَا بِالْإِيمَانِ، وَزَيِّنْ أَيَّامَنَا بِالسَّعَادَةِ، وَاجْععلْ يَوْمَ الْجُمُعَةِ نُورًا لَنَا وَمَغْفِرَةً.",
        category: "جمعة",
    },
    {
        title: "استجابة الجمعة",
        dua: "يا رب في يوم الجمعة وعدت عبادك بقبول دعواتهم، اللهم ارحم موتانا، واشف مرضانا، واستجب لدعائنا، واغفر لنا ذنوبنا.",
        category: "جمعة",
    },
    {
        title: "دعاء النوم",
        dua: "بِاسمِكَ رَبِّي وَضَعْتُ جَنْبِي، وَبِكَ أَرْفَعُهُ، فَإِنْ أَمْسَكْتَ نَفْسِي فَارْحَمْهَا، وَإِنْ أَرْسَلْتَهَا فَاحْفَظْهَا بِمَا تَحْفَظُ بِهِ عِبَادَكَ الصَّالِحِينَ.",
        category: "نوم",
    },
    {
        title: "أذكار النوم",
        dua: "اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ. (ثلاث مرات)",
        category: "نوم",
    },
    {
        title: "قبل النوم",
        dua: "بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا.",
        category: "نوم",
    },
    {
        title: "دعاء السكينة",
        dua: "اللهم رب السماوات ورب الأرض ورب العرش العظيم، ربنا ورب كل شيء، فالق الحب والنوى، ومنزل التوراة والإنجيل والفرقان، أعوذ بك من شر كل شيء أنت آخذ بناصيته.",
        category: "نوم",
    },
];

function getRandomDua(category = null) {
    let filtered = islamicDuas;
    if (category) {
        filtered = islamicDuas.filter((d) => d.category === category);
        if (filtered.length === 0) filtered = islamicDuas;
    } else {
        filtered = islamicDuas.filter(
            (d) => d.category !== "جمعة" && d.category !== "نوم",
        );
    }
    return filtered[Math.floor(Math.random() * filtered.length)];
}

const quranSessions = {};

module.exports = {
    loadDuasData,
    saveDuasData,
    islamicDuas,
    getRandomDua,
    quranSessions,
};
